---
title: "Using A Passkey with SSH"
description: Authenticate SSH connections with Passkeys. 
date: 2024-03-23T08:34:00+01:00
draft: false
toc: true
pinned: false
images: [/images/passkeyauthentication.png]
featuredImage: ''
tags: [PowerShell]
categories: [Windows]
series: [Windows SSH]
---

Passkeys provide secure, passwordless authentication for websites and apps.  Here's how to use passkeys with SSH.

<!--more-->

[Passkeys](https://fidoalliance.org/passkeys/) provide user authentication using methods such as fingerprint, face ID or PIN entry.  As well as providing a method to log in to websites such as Apple, Microsoft and Google, they can also be used by applications requiring user authentication, including SSH.

SSH is a core element of the [OpenSSH](https://www.openssh.com/) project.  Several Unix-like operating systems are supported. Microsoft Windows is also fully supported.

> TL;DR
> 1. Open a PowerShell console as Admin.
> 1. Install the latest version of [OpenSSH for Windows](https://github.com/PowerShell/Win32-OpenSSH/wiki/Install-Win32-OpenSSH-Using-MSI), with `winget install Microsoft.OpenSSH.Beta`.
> 1. Generate a new key pair, with: `ssh-keygen -t ecdsa-sk`.
> 1. Copy the new .pub key to the remote server, with: `Get-Content $env:USERPROFILE\.ssh\id_ecdsa_sk.pub | ssh alice@example.com 'mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys'` (change alice@example.com to your user/server).
> 1. SSH to the server, with: `ssh alice@example.com` (change alice@example.com to your user/server).

## Install The Latest Beta Version of OpenSSH for Windows

SSH is included in Windows as a `Windows Optional Feature`, see the [Microsoft Docs](https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse) page for more information.  As such it is updated as part of Windows Feature Updates. 

To find the version currently installed, use:

```PowerShell
ssh -V
```

At the time of writing, this returns: "OpenSSH_for_Windows_8.6p1, LibreSSL 3.4.3".  This version does not support Passkeys or FIDO2 hardware security keys (YubiKeys), so it needs to be updated to a newer version.

To install the latest version available to the public, the latest *beta* version:

```PowerShell
winget install Microsoft.OpenSSH.Beta
```

The exit PowerShell and re-open it. The SSH version should now have changed, check it again, with:

```PowerShell
ssh -V
```

At the time of writing, this is now: "OpenSSH_for_Windows_9.5p1, LibreSSL 3.8.2", which supports Passkeys.

### Create An SSH Key Pair

Use the `ssh-keygen` command to create a public/private key pair. 

The type of key used in this example is "ecdsa-sk". 

A simple example would be:

```PowerShell
ssh-keygen -t ecdsa-sk
```

You might want to add to this and use the following optional parameters:

- use `-O` to specify the application (SSH) and remote server name (in this example, "server21"), *example:* `-O application=ssh:server21`
- use `-C` to specify a comment, *example:* `-C "Host:ThinkPadX1"`

For example:

```PowerShell
ssh-keygen -t ecdsa-sk -O application=ssh:server21 -C "Host:ThinkPadX1"
```

Follow the on-screen instructions. As you are using a hardware security key, you will see a number of prompts generated by Windows Secuirty, guiding you through the process.

![dialog box asking for a PIN or fingerprint](passkeycreation.png "Making sure it's you")

Confirmation that the passkey was saved is shown in the dialog box.

![dialog box confirm the passkey was saved](passkeysaved.png "confirmation message")

- follow the instructions in the terminal window
- enter a specific name for the key pair you are creating, or accept the default values
- optional, enter a passphrase for the key pair you are creating, or leave blank

The `ssh-keygen` command will generate a public/private key pair.  The public key will be stored in the `.ssh/id_ecdsa.pub` file, and the private key will be stored in the `.ssh/id_ecdsa` file.

To view the public key, use one of these commands:

```PowerShell
Get-Content $env:USERPROFILE\.ssh\id_ecdsa_sk.pub
```

or, in a CMD prompt:

```Batchfile
type $env:USERPROFILE\.ssh\id_ecdsa_sk.pub
```

or, this Linux style command will be accepted by PowerShell:

```Bash
cat ~/.ssh/id_ecdsa_sk.pub
```

### Copy The Public Key To The Remote Server

The public key you just created, ~/.ssh/id_ecdsa_sk.pub, must be copied to the remote server. The current version of OpenSSH for Windows does not support the `ssh-copy-id` command. To copy the .pub key to the remote server, use:

> Note, before using one of the examples below, replace `same@server21` to the actual user and remote server you are using, *for example* `betty@108.23.54.237`.
    
```PowerShell
Get-Content $env:USERPROFILE\.ssh\id_ecdsa_sk.pub | ssh sam@server21 'mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys'
```

or, in a CMD prompt:

```Batchfile
type $env:USERPROFILE\.ssh\id_ecdsa_sk.pub | ssh sam@server21 'mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys'
```

or, this Linux style command will be accepted by PowerShell:

```Bash
cat ~/.ssh/id_ecdsa_sk.pub | ssh sam@server21 'mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys'
```

### Test The Connection

Now you can SSH to the remote server, and you should be able to use Passkey to authenticate.

```PowerShell
ssh sam@server21
```

Confirm it is you:

![screen shot of an SSH connection authenticating with a passkey](passkeyauthentication.png "Making sure it's you")